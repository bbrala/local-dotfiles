#!/usr/bin/env bash
set -x
VERSION=${1:-9.5.x}
VERSION_CLEAN=${VERSION//./-}
PROJECTS_PATH=${PROJECTS_PATH:-$HOME/projects}

cd ${PROJECTS_PATH}
if  ! test -d  jsonapi_extras; then
  git clone git@git.drupal.org:project/jsonapi_extras
else
  pushd jsonapi_extras
  git pull --all
  popd
fi

if  ! test -d  drupal-extras-${VERSION_CLEAN}/web; then
  rm -rf drupal-extras-${VERSION_CLEAN}
  composer create-project drupal/recommended-project drupal-extras-${VERSION_CLEAN} --no-install ${VERSION}-dev
  pushd drupal-extras-${VERSION_CLEAN}

  composer config minimum-stability dev
  composer config repositories.jsonapi_extras path "$PROJECTS_PATH/jsonapi_extras"

  composer require --dev drupal/core-dev:${VERSION}-dev -W
  composer require --dev phpspec/prophecy-phpunit:^2 -W
  composer require --dev drush/drush

  composer require drupal/jsonapi_extras
  ln -s web public_html


  vendor/bin/drush --yes site:install standard \
      install_configure_form.site_default_country=NL \
      install_configure_form.date_default_timezone=Europe/Amsterdam \
      install_configure_form.enable_update_status_module=1 \
      install_configure_form.enable_update_status_emails=NULL \
      --locale="en" \
      --site-name="jsonapi testsite" \
      --site-mail="bjorn@swis.nl" \
      --account-name="root" \
      --account-pass="root" \
      --account-mail="bjorn@swis.nl" \
      --db-url="mysql://root:root@localhost/drupal_extras_${VERSION//./_}"

  chmod -R 777 web/sites/default
  cp web/sites/example.settings.local.php web/sites/default/settings.local.php
  cp web/core/phpunit.xml.dist web/core/phpunit.xml
  mkdir -p web/sites/simpletest/browser_output
  chmod -R 777 web/sites/simpletest
  sed -i 's|name="SIMPLETEST_BASE_URL" value=""|name="SIMPLETEST_BASE_URL" value="https://drupal-extras'${VERSION//./-}'\.swisdev\.nl"|g' web/core/phpunit.xml
  sed -i 's|name="SIMPLETEST_DB" value=""|name="SIMPLETEST_DB" value="mysql://root:root@localhost/drupal_extras_'${VERSION//./_}'"|g' web/core/phpunit.xml
  sed -i 's|name="BROWSERTEST_OUTPUT_DIRECTORY" value=""|name="BROWSERTEST_OUTPUT_DIRECTORY" value="../sites/simpletest/browser_output"|g' web/core/phpunit.xml
  sed -i 's|<!-- <env name="SYMFONY_DEPRECATIONS_HELPER" value="disabled"/> -->|<env name="SYMFONY_DEPRECATIONS_HELPER" value="disabled"/>|g' web/core/phpunit.xml

  pushd web
  drush en -y jsonapi_extras
else
  pushd drupal-extras-${VERSION_CLEAN}/web
  git pull --all
fi
